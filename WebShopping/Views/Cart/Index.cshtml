@using WebShopping.Models
@{
    ViewBag.Title = "Giỏ hàng";
    List<CartItemVIewModel> lsChiTietGioHang = (List<CartItemVIewModel>)ViewBag.ListItemInCart;
}

@section styles{
    <style>
        .cart-area .quantity > div {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }

            .cart-area .quantity > div > a {
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                border: .5px solid #efefef;
                border-radius:5px;
            }

            .cart-area .quantity > div > div {
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
    </style>
}

<main class="main-content">
    <div class="breadcrumb-area breadcrumb-height" style="background-image: url('/Content/assets/images/banner/bg2.jpg')">
        <div class="container h-100">
            <div class="row h-100">
                <div class="col-lg-12">
                    <div class="breadcrumb-item">
                        <h2 class="breadcrumb-heading">Giỏ hàng</h2>
                        <ul>
                            <li>
                                <a href="/">Trang chủ <i class="pe-7s-angle-right"></i></a>
                            </li>
                            <li>Giỏ hàng</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="cart-area section-space-y-axis-100">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <form action="javascript:void(0)">
                        <div class="table-content table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width:30px;" class="product_remove"></th>
                                        <th style="width:100px;" class="product-thumbnail">images</th>
                                        <th class="cart-product-name">Product</th>
                                        <th class="product-price">Unit Price</th>
                                        <th style="width:100px;" class="product-quantity">Quantity</th>
                                        <th class="product-subtotal">Total</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    @{
                                        foreach (var item in lsChiTietGioHang)
                                        {
                                            <tr data-id="@item.ChiTietGioHangId" id="@item.ChiTietGioHangId">
                                                <td class="product_remove"><a href="DeleteCartItem(this);"><i class="pe-7s-close" title="Remove"></i></a></td>
                                                <td class="product-thumbnail">
                                                    <a href="javascript:void(0)">
                                                        <div style="width:100px;height:100px;background-position:center;background-size:cover;background-repeat:no-repeat; background-image:url(@item.AnhDaiDien);"></div>
                                                    </a>
                                                </td>
                                                <td class="product-name"><a href="javascript:void(0)">@item.TenSanPham</a></td>
                                                <td class="product-price"><span class="amount">@item.Gia</span></td>
                                                <td class="quantity">
                                                    <div>
                                                        <a onclick="DecreaseQuantity(this);">-</a>
                                                        <div>@item.SoLuong</div>
                                                        <a onclick="IncreaseQuantity(this);">+</a>
                                                    </div>
                                                </td>
                                                <td class="product-subtotal"><span class="amount">@(item.SoLuong * item.Gia)</span></td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="row">
                            <div class="col-md-5 ml-auto">
                                <div class="cart-page-total">
                                    <a onclick="CreateOrder();">Đặt hàng</a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

@section scripts{
    <script>
        var DecreaseQuantity = function (el) {
            const id = $(el).closest('tr').data('id');
            const tr = $(el).closest('tr');
            $.get('/cart/DecreaseQuantity?chiTietId=' + id, function (rs) {
                if (GetObjectProperty(rs, 'status') == Enum.ResponseStatus.SUCCESS) {
                    let quantity = $(el).siblings('div').text();
                    quantity = parseInt(quantity);
                    quantity -= 1;

                    if (quantity === 0) {
                        $(tr).remove(); return;
                    }

                    $(el).siblings('div').text(quantity);

                    let total = $(tr).find('.product-subtotal .amount').text();
                    total = parseInt(total);
                    let price = $(tr).find('.product-price .amount').text();
                    price = parseInt(price);

                    total -= price;
                    
                    $(tr).find('.product-subtotal .amount').text(total);
                    CountItemInCart();
                }
            });
        }
        var IncreaseQuantity = function (el) {
            const id = $(el).closest('tr').data('id');
            const tr = $(el).closest('tr');
            $.get('/cart/IncreaseQuantity?chiTietId=' + id, function (rs) {
                if (GetObjectProperty(rs, 'status') == Enum.ResponseStatus.SUCCESS) {
                    let quantity = $(el).siblings('div').text();
                    quantity = parseInt(quantity);
                    quantity += 1;
                    $(el).siblings('div').text(quantity);

                    let total = $(tr).find('.product-subtotal .amount').text();
                    total = parseInt(total);
                    let price = $(tr).find('.product-price .amount').text();
                    price = parseInt(price);

                    total += price;
                    $(tr).find('.product-subtotal .amount').text(total);
                    CountItemInCart();
                }
            });
        }

        var CreateOrder = function () {
            $.get('/cart/checkout', function (rs) {
                if (GetObjectProperty(rs, 'status') === Enum.ResponseStatus.ERROR) {
                    if (GetObjectProperty(rs, 'message') !== '') alert(GetObjectProperty(rs, 'message'));
                    return;
                }
                if (GetObjectProperty(rs, 'status') === Enum.ResponseStatus.SUCCESS) {
                    alert('Bạn đã đặt hàng thành công. Cửa hàng sẽ xử lý đơn dặt hàng của bạn sớm nhất có thể.');
                    window.location.reload();
                }
            });
        }
    </script>
}